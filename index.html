<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Табель</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .ok { font-size: 18px; }
    .small { color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="status" class="ok">Загрузка...</div>
  <div id="details" class="small"></div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0DMs8jhEFcjcTjA8mjfbTHSlI9OZnpkR5rK6OljVwNUB515gazEjVpVPRwmOD-80I/exec";

    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

    // Если открыли НЕ в Telegram — просто инструкция
    if (!tg) {
      statusEl.textContent = "Откройте через Telegram-бота.";
      detailsEl.textContent = "Через обычный браузер отметка не выполняется.";
      throw new Error("Not in Telegram WebApp");
    }

    tg.ready();

    const initData = tg.initData || "";
    const unsafe = tg.initDataUnsafe || {};
    const user = unsafe.user || {};

    if (!initData) {
      statusEl.textContent = "Нет данных Telegram (initData).";
      detailsEl.textContent = "Откройте через startapp-ссылку или кнопку Mini App в боте.";
      throw new Error("Empty initData");
    }

    // in/out
    const startParam =
      unsafe.start_param ||
      new URLSearchParams(window.location.search).get("tgWebAppStartParam") ||
      "";

    const action = (String(startParam).toLowerCase() === "out") ? "OUT" : "IN";

    statusEl.textContent = "Отмечаем...";

    const payload = {
      initData,
      action,
      user: {
        id: user.id || null,
        first_name: user.first_name || null,
        last_name: user.last_name || null
      }
    };

    // Отправляем как форму payload=...
    const formBody = "payload=" + encodeURIComponent(JSON.stringify(payload));

    fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: formBody
    })
    .then(async (r) => {
      const txt = await r.text();
      if (!r.ok) throw new Error(txt || ("HTTP " + r.status));
      return txt;
    })
    .then((txt) => {
      statusEl.textContent = "Ответ сервера: " + txt;
      detailsEl.textContent = "Если тут ok — запись должна быть в таблице.";
      setTimeout(() => tg.close(), 1200);
    })
    .catch((e) => {
      statusEl.textContent = "Ошибка отметки.";
      detailsEl.textContent = String(e && (e.message || e) ? (e.message || e) : e);
    });
  </script>
</body>
</html>
