<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0DMs8jhEFcjcTjA8mjfbTHSlI9OZnpkR5rK6OljVwNUB515gazEjVpVPRwmOD-80I/exec";

  const statusEl = document.getElementById('status');
  const detailsEl = document.getElementById('details');

  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  if (!tg) {
    statusEl.textContent = "Откройте через Telegram-бота.";
    detailsEl.textContent = "Через обычный браузер отметка не выполняется.";
    throw new Error("Not in Telegram WebApp");
  }

  tg.ready();

  if (typeof tg.showScanQrPopup !== "function") {
    statusEl.textContent = "Сканер QR не поддерживается.";
    detailsEl.textContent = "Обновите Telegram и попробуйте снова.";
    throw new Error("showScanQrPopup not supported");
  }

  const initData = tg.initData || "";
  const unsafe = tg.initDataUnsafe || {};
  const user = unsafe.user || {};

  if (!initData) {
    statusEl.textContent = "Нет данных Telegram (initData).";
    detailsEl.textContent = "Откройте Mini App из бота.";
    throw new Error("Empty initData");
  }

  function renderFallbackButton() {
    statusEl.textContent = "Для отметки отсканируйте QR.";
    detailsEl.innerHTML = '<button id="scanBtn" style="font-size:18px;padding:10px 14px;">Сканировать QR</button>';

    document.getElementById("scanBtn").onclick = () => openScanner();
  }

  async function sendToServer(action, qrText) {
    const payload = {
      initData,
      action,
      qrText: String(qrText || ""),
      user: {
        id: user.id || null,
        first_name: user.first_name || null,
        last_name: user.last_name || null
      }
    };

    const formBody = "payload=" + encodeURIComponent(JSON.stringify(payload));

    const r = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: formBody
    });

    return await r.text();
  }

  function openScanner() {
    statusEl.textContent = "Наведите камеру на QR...";
    detailsEl.textContent = "";

    tg.showScanQrPopup(
      { text: "Наведите камеру на QR для отметки" },
      async (qrText) => {
        try {
          const raw = String(qrText || "").trim();
          const norm = raw.toUpperCase();

          let action = null;
          if (norm === "IN") action = "IN";
          if (norm === "OUT") action = "OUT";

          if (!action) {
            statusEl.textContent = "Неверный QR.";
            detailsEl.textContent = "Используйте QR на входе (IN) или на выходе (OUT).";
            return true; // закрыть сканер
          }

          statusEl.textContent = "Отмечаем...";
          const txt = await sendToServer(action, raw);

          statusEl.textContent = "Ответ сервера: " + txt;
          detailsEl.textContent = (txt === "ok") ? "Отметка выполнена." : "Ошибка: " + txt;

          if (txt === "ok") setTimeout(() => tg.close(), 1200);
          else setTimeout(() => renderFallbackButton(), 1200);

          return true; // закрыть сканер
        } catch (e) {
          statusEl.textContent = "Ошибка отметки.";
          detailsEl.textContent = String(e && (e.message || e) ? (e.message || e) : e);
          setTimeout(() => renderFallbackButton(), 1200);
          return true;
        }
      }
    );
  }

  // Автозапуск сканера при открытии Mini App
  // Небольшая задержка повышает шанс, что Telegram успеет полностью инициализировать WebApp.
  setTimeout(() => {
    try {
      openScanner();
    } catch (e) {
      renderFallbackButton();
    }
  }, 150);
</script>
