<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Табель</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .ok { font-size: 18px; }
    .small { color: #666; margin-top: 10px; }
    button { font-size: 18px; padding: 10px 14px; }
  </style>
</head>
<body>
  <div id="status" class="ok">Загрузка...</div>
  <div id="details" class="small"></div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0DMs8jhEFcjcTjA8mjfbTHSlI9OZnpkR5rK6OljVwNUB515gazEjVpVPRwmOD-80I/exec";

    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

    if (!tg) {
      statusEl.textContent = "Откройте через Telegram-бота.";
      detailsEl.textContent = "Через обычный браузер отметка не выполняется.";
      throw new Error("Not in Telegram WebApp");
    }

    tg.ready();

    if (typeof tg.showScanQrPopup !== "function") {
      statusEl.textContent = "Сканер QR не поддерживается.";
      detailsEl.textContent = "Обновите Telegram и попробуйте снова.";
      throw new Error("showScanQrPopup not supported");
    }

    const initData = tg.initData || "";
    const unsafe = tg.initDataUnsafe || {};
    const user = unsafe.user || {};

    if (!initData) {
      statusEl.textContent = "Нет данных Telegram (initData).";
      detailsEl.textContent = "Откройте Mini App из бота.";
      throw new Error("Empty initData");
    }

    function renderScanUI() {
      statusEl.textContent = "Для отметки отсканируйте QR.";
      detailsEl.innerHTML = '<button id="scanBtn">Сканировать QR</button><div style="margin-top:10px;color:#666;">QR на входе: IN, QR на выходе: OUT</div>';

      const btn = document.getElementById("scanBtn");
      btn.onclick = () => openScanner();
    }

    function openScanner() {
      statusEl.textContent = "Откройте камеру и наведите на QR...";
      detailsEl.textContent = "";

      tg.showScanQrPopup(
        { text: "Наведите камеру на QR для отметки" },
        async (qrText) => {
          try {
            const raw = String(qrText || "").trim();
            const norm = raw.toUpperCase();

            let action = null;
            if (norm === "IN") action = "IN";
            if (norm === "OUT") action = "OUT";

            if (!action) {
              statusEl.textContent = "Неверный QR.";
              detailsEl.textContent = "Используйте QR на входе (IN) или на выходе (OUT).";
              return true; // закрыть сканер
            }

            statusEl.textContent = "Отмечаем...";
            detailsEl.textContent = "Действие: " + (action === "IN" ? "Приход" : "Уход");

            const payload = {
              initData,
              action,
              qrText: raw,
              user: {
                id: user.id || null,
                first_name: user.first_name || null,
                last_name: user.last_name || null
              }
            };

            const formBody = "payload=" + encodeURIComponent(JSON.stringify(payload));

            const r = await fetch(WEBAPP_URL, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
              body: formBody
            });

            const txt = await r.text();

            statusEl.textContent = "Ответ сервера: " + txt;
            detailsEl.textContent = (txt === "ok")
              ? "Отметка выполнена."
              : "Не выполнено. " + txt;

            if (txt === "ok") {
              setTimeout(() => tg.close(), 1200);
            } else {
              // если сервер вернул ошибку — остаёмся в приложении
              setTimeout(() => renderScanUI(), 1200);
            }

            return true; // закрыть сканер после скана
          } catch (e) {
            statusEl.textContent = "Ошибка отметки.";
            detailsEl.textContent = String(e && (e.message || e) ? (e.message || e) : e);
            setTimeout(() => renderScanUI(), 1200);
            return true; // закрыть сканер
          }
        }
      );
    }

    renderScanUI();
  </script>
</body>
</html>
