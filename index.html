<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Табель</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    .ok { font-size: 18px; }
    .small { color: #666; margin-top: 10px; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div id="status" class="ok">Загрузка...</div>
  <div id="details" class="small"></div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwgGJXuT_sIk4si-qt9e9Krhqqnf9u4fsIZ3NWuuQFZeZu79aXCcFleNqzjypa66gIp/exec";

    const statusEl = document.getElementById('status');
    const detailsEl = document.getElementById('details');

    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    // 1) Если открыли НЕ в Telegram — просто показываем инструкцию и ничего не отправляем
    if (!tg) {
      statusEl.textContent = "Откройте эту страницу через Telegram-бота.";
      detailsEl.textContent = "Через обычный браузер отметка не выполняется.";
      throw new Error("Not in Telegram WebApp");
    }

    tg.ready();

    const initData = tg.initData || "";
    const unsafe = tg.initDataUnsafe || {};
    const user = unsafe.user || {};

    // Если initData пустой — значит Telegram не передал авторизацию (такое бывает, если открыто не как Mini App)
    if (!initData) {
      statusEl.textContent = "Нет данных Telegram (initData).";
      detailsEl.textContent = "Откройте через кнопку Mini App / startapp-ссылку в Telegram.";
      throw new Error("Empty initData");
    }

    // startapp параметр (in/out)
    const startParam =
      unsafe.start_param ||
      new URLSearchParams(window.location.search).get("tgWebAppStartParam") ||
      "";

    const action = (String(startParam).toLowerCase() === "out") ? "OUT" : "IN";

    statusEl.textContent = "Отмечаем...";

    const payload = {
      initData,
      action,
      user: {
        id: user.id || null,
        first_name: user.first_name || null,
        last_name: user.last_name || null
      }
    };

    // 2) Отправка в Apps Script
    fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      // Чтобы браузер не ругался на CORS, а Telegram WebView всё равно отправит запрос
      mode: "no-cors",
      body: JSON.stringify(payload)
    })
    .then(() => {
      statusEl.textContent = "Готово. Отметка выполнена.";
      detailsEl.textContent = "Окно закроется автоматически.";
      setTimeout(() => tg.close(), 1200);
    })
    .catch((e) => {
      statusEl.textContent = "Ошибка отметки.";
      detailsEl.textContent = String(e.message || e);
    });
  </script>
</body>
</html>
