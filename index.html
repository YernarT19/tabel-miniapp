<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tabel Damu</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    #status { font-size: 18px; }
    #details { color: #666; margin-top: 10px; white-space: pre-wrap; }
    button { font-size: 18px; padding: 10px 14px; }
  </style>
</head>
<body>
  <div id="status">Загрузка...</div>
  <div id="details"></div>

  <script>
    (function () {
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0DMs8jhEFcjcTjA8mjfbTHSlI9OZnpkR5rK6OljVwNUB515gazEjVpVPRwmOD-80I/exec";

      const statusEl = document.getElementById("status");
      const detailsEl = document.getElementById("details");

      function show(msg, details) {
        statusEl.textContent = msg;
        detailsEl.textContent = details || "";
      }

      window.onerror = function (msg, src, line, col) {
        show(
          "Ошибка JavaScript",
          "msg: " + msg + "\n" +
          "src: " + (src || "") + "\n" +
          "line: " + line + ", col: " + col
        );
        return true;
      };

      function getLocationOnce() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              resolve({
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                acc: pos.coords.accuracy,
                ts: Date.now()
              });
            },
            (err) => {
              reject(new Error(err && err.message ? err.message : "Location denied"));
            },
            { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
          );
        });
      }

      const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
      if (!tg) {
        show("Откройте через Telegram-бота.", "В обычном браузере отметка не выполняется.");
        return;
      }

      tg.ready();
      tg.expand();

      if (typeof tg.showScanQrPopup !== "function") {
        show("Сканер QR не поддерживается.", "Обновите Telegram и попробуйте снова.");
        return;
      }

      const initData = tg.initData || "";
      const unsafe = tg.initDataUnsafe || {};
      const user = unsafe.user || {};

      if (!initData) {
        show(
          "Нет данных Telegram (initData).",
          "Откройте мини-приложение через кнопку/меню бота.\n" +
          "Не открывайте страницу по ссылке в браузере."
        );
        return;
      }

      async function sendToServer(action, qrText, location) {
        const payload = {
          initData,
          action,
          qrText: String(qrText || ""),
          location: location || null,
          // user можно оставлять для дебага, но сервер НЕ должен ему доверять
          user: {
            id: user.id || null,
            first_name: user.first_name || null,
            last_name: user.last_name || null
          }
        };

        const body = "payload=" + encodeURIComponent(JSON.stringify(payload));

        const r = await fetch(WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        return await r.text();
      }

      function renderButton() {
        statusEl.textContent = "Для отметки отсканируйте QR.";
        detailsEl.innerHTML =
          '<button id="scanBtn">Сканировать QR</button><br><br>' +
          'QR на входе: IN<br>' +
          'QR на выходе: OUT';
        document.getElementById("scanBtn").onclick = () => openScanner();
      }

      function openScanner() {
        show("Наведите камеру на QR...", "");

        tg.showScanQrPopup(
          { text: "Наведите камеру на QR для отметки" },
          async (qrText) => {
            try {
              const raw = String(qrText || "").trim();
              const norm = raw.toUpperCase();

              let action = null;
              if (norm === "IN") action = "IN";
              if (norm === "OUT") action = "OUT";

              if (!action) {
                show("Неверный QR.", "QR должен содержать IN или OUT.");
                return true;
              }

              // 1) Геолокация
              let loc;
              try {
                show("Получаем геолокацию...", "Разрешите доступ к геолокации.");
                loc = await getLocationOnce();
              } catch (e) {
                show(
                  "Геолокация не получена.",
                  "Включите геолокацию и разрешите Telegram доступ.\n" +
                  "Без геолокации отметка не выполняется.\n" +
                  "Ошибка: " + String(e && (e.message || e) ? (e.message || e) : e)
                );
                return true;
              }

              // 2) Отправка
              show(
                "Отмечаем...",
                "Действие: " + (action === "IN" ? "Приход" : "Уход") + "\n" +
                "Точность: " + (loc && isFinite(loc.acc) ? Math.round(loc.acc) + " м" : "—")
              );

              const txt = await sendToServer(action, raw, {
                lat: loc.lat,
                lon: loc.lon,
                acc: loc.acc,
                ts: loc.ts
              });

              if (String(txt).trim() === "ok") {
                show("Готово.", "Отметка выполнена.");
                setTimeout(() => tg.close(), 1200);
              } else {
                show("Отказ.", String(txt || "no response"));
              }

              return true;
            } catch (e) {
              show("Ошибка отметки.", String(e && (e.message || e) ? (e.message || e) : e));
              return true;
            }
          }
        );
      }

      // Автозапуск сканера. Если Telegram/OS блокирует — покажем кнопку.
      setTimeout(() => {
        try {
          openScanner();
        } catch (e) {
          renderButton();
        }
      }, 150);

      // На случай если showScanQrPopup заблокирован автозапуском, кнопка остаётся доступной
      // (покажем её через небольшую задержку, если статус всё ещё "Наведите камеру...")
      setTimeout(() => {
        if (statusEl.textContent && statusEl.textContent.indexOf("Наведите камеру") >= 0 && !document.getElementById("scanBtn")) {
          renderButton();
        }
      }, 1200);

    })();
  </script>
</body>
</html>
